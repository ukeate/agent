# Story 2.2: LangGraph State Management Workflow

## Status
Done

## Story
**As a** 系统架构师，
**I want** 有统一的工作流状态管理，
**so that** 复杂的多步骤任务能够可靠地执行和恢复。

## Acceptance Criteria
1. LangGraph StateGraph框架集成并配置完成
2. 定义统一的MessagesState数据结构
3. 实现工作流的检查点和状态持久化
4. 支持工作流的暂停、恢复和错误处理
5. 条件路由和动态流程控制实现
6. 工作流执行状态的可视化展示
7. 状态变更的审计日志和调试信息

## Tasks / Subtasks

- [x] 集成LangGraph StateGraph框架 (AC: 1)
  - [x] 安装LangGraph 0.0.69+依赖包到pyproject.toml
  - [x] 创建LangGraph服务层基础架构目录结构
  - [x] 实现StateGraph基础配置和初始化
  - [x] 配置LangGraph与现有系统的集成点

- [x] 定义统一的MessagesState数据结构 (AC: 2)
  - [x] 创建MessagesState TypedDict定义
  - [x] 定义状态字段：messages, metadata, context, workflow_id
  - [x] 实现状态验证和序列化机制
  - [x] 创建状态工厂函数和辅助方法

- [x] 实现工作流检查点和持久化 (AC: 3)
  - [x] 实现PostgreSQL检查点存储后端
  - [x] 创建检查点保存和恢复机制
  - [x] 实现状态快照序列化和反序列化
  - [x] 添加检查点版本管理和清理策略

- [x] 开发工作流控制机制 (AC: 4)
  - [x] 实现工作流暂停和恢复功能
  - [x] 创建错误处理和重试策略
  - [x] 实现工作流超时和取消机制
  - [x] 添加工作流状态事件监听器

- [x] 实现条件路由和流程控制 (AC: 5)
  - [x] 创建条件节点和路由函数
  - [x] 实现基于状态的分支逻辑
  - [x] 开发动态节点添加和删除功能
  - [x] 创建流程模板和可重用组件

- [x] 扩展前端工作流可视化 (AC: 6)
  - [x] 创建WorkflowVisualization组件
  - [x] 实现状态图的实时渲染
  - [x] 添加节点状态和进度显示
  - [x] 开发交互式流程调试界面

- [x] 实现审计日志和调试系统 (AC: 7)
  - [x] 创建状态变更日志记录器
  - [x] 实现详细的调试信息收集
  - [x] 添加性能指标和执行时间跟踪
  - [x] 开发日志查询and分析接口

- [x] 创建工作流管理API接口 (AC: 1-7)
  - [x] 实现POST /api/v1/workflows接口创建工作流
  - [x] 实现GET /api/v1/workflows/{id}/status查询状态
  - [x] 实现PUT /api/v1/workflows/{id}/control控制工作流
  - [x] 实现GET /api/v1/workflows/{id}/checkpoints获取检查点

- [x] 开发示例工作流模板 (AC: 5, 6)
  - [x] 创建简单线性工作流示例
  - [x] 实现带条件分支的工作流示例
  - [x] 开发并行执行工作流示例
  - [x] 创建错误处理和恢复示例

- [x] 编写LangGraph集成测试 (AC: 1-7)
  - [x] 创建StateGraph初始化测试
  - [x] 编写状态持久化和恢复测试
  - [x] 实现工作流控制功能测试
  - [x] 添加条件路由和分支测试
  - [x] 开发端到端工作流执行测试

## Dev Notes

### Previous Story Insights
基于Story 2.1的完成情况，多智能体协作系统已经建立：
- AutoGen多智能体框架已集成，支持群组对话 [Source: Story 2.1 completion notes]
- WebSocket实时通信基础已建立，可扩展用于工作流状态推送 [Source: Story 2.1 dev notes]
- 前端状态管理和实时更新机制已实现 [Source: Story 2.1 implementation]
- 多智能体会话状态管理经验可应用于工作流状态管理 [Source: Story 2.1 completion]

### Tech Stack Requirements
基于架构文档的LangGraph技术要求：[Source: architecture/tech-stack.md]
- **AI Orchestration**: LangGraph 0.0.69+ - 多智能体工作流编排，状态管理，条件分支，可视化调试
- **Database**: PostgreSQL 15+ - 状态检查点持久化，JSON字段支持工作流定义
- **Cache**: Redis 7.2+ - 工作流执行状态缓存，临时状态存储
- **Backend Framework**: FastAPI 0.104+ - 异步工作流API，WebSocket状态推送

### LangGraph Orchestrator Component Architecture
基于架构文档的LangGraph集成设计：[Source: architecture/components.md#langgraph-orchestrator]
- **Responsibility**: 管理复杂工作流执行，状态管理，条件分支控制
- **Key Interfaces**: 工作流定义API，状态管理接口，检查点管理，执行控制
- **Dependencies**: PostgreSQL (检查点存储), Redis (状态缓存), AutoGen Agent Pool
- **Technology Stack**: LangGraph 0.0.69+, StateGraph API, 检查点持久化

### Data Models for Workflow State Management
基于架构文档的数据模型：[Source: architecture/data-models.md]

**Task Model** (用于工作流任务管理):
```typescript
interface Task {
  id: string;
  dag_execution_id: string;
  name: string;
  type: string;
  status: 'pending' | 'running' | 'completed' | 'failed' | 'skipped';
  input_data: Record<string, any>;
  output_data: Record<string, any>;
  error_message?: string;
  dependencies: string[];
  agent_id?: string;
  started_at?: Date;
  completed_at?: Date;
  created_at: Date;
  updated_at: Date;
}
```

**DAGExecution Model** (用于工作流执行状态):
```typescript
interface DAGExecution {
  id: string;
  conversation_id: string;
  graph_definition: {
    nodes: Array<{id: string; type: string; data: any}>;
    edges: Array<{source: string; target: string; condition?: string}>;
  };
  status: 'pending' | 'running' | 'completed' | 'failed' | 'paused';
  current_task_id?: string;
  context: Record<string, any>;
  checkpoints: Array<{
    id: string;
    task_id: string;
    state: Record<string, any>;
    created_at: Date;
  }>;
  progress: {
    total_tasks: number;
    completed_tasks: number;
    failed_tasks: number;
  };
  started_at?: Date;
  completed_at?: Date;
  created_at: Date;
  updated_at: Date;
}
```

### Backend Architecture Requirements
基于架构文档的后端服务层设计：[Source: architecture/backend-architecture.md]
- **Service Layer**: 创建src/services/workflow_service.py - 工作流业务逻辑
- **Repository Layer**: 创建src/repositories/workflow_repository.py - 工作流数据访问
- **API Layer**: 添加src/api/v1/workflows.py - 工作流管理路由
- **AI Integration**: 创建src/ai/langgraph/ - LangGraph框架集成目录

### File Locations and Structure
基于架构文档的文件路径要求：[Source: architecture/unified-project-structure.md]
- **LangGraph集成**: src/ai/langgraph/state_graph.py, src/ai/langgraph/checkpoints.py
- **工作流服务**: src/services/workflow_service.py
- **数据库模型**: src/models/database/workflow.py, src/models/schemas/workflow.py
- **API路由**: src/api/v1/workflows.py
- **前端组件**: apps/web/src/components/workflow/
- **状态管理**: apps/web/src/stores/workflowStore.ts

### State Management Architecture
基于LangGraph状态管理要求：
- **MessagesState结构**: 包含messages列表、metadata字典、workflow上下文
- **检查点策略**: 每个节点执行后自动保存，支持手动检查点
- **状态更新模式**: 不可变更新，使用状态转换函数
- **并发控制**: 使用乐观锁防止状态冲突

### Workflow Control Patterns
基于架构文档的工作流控制模式：
- **暂停/恢复**: 通过设置execution status和保存当前状态实现
- **错误处理**: 自动重试、降级处理、人工介入选项
- **超时控制**: 节点级和工作流级超时设置
- **取消机制**: 优雅终止，清理资源，保存终止状态

### API Interface Design
基于工作流管理需求的API设计：
- **POST /api/v1/workflows**: 创建新工作流
  - 请求：工作流定义、初始状态、配置参数
  - 响应：工作流ID、初始状态、执行计划
- **GET /api/v1/workflows/{id}/status**: 查询工作流状态
  - 响应：当前状态、进度、活动节点、检查点信息
- **PUT /api/v1/workflows/{id}/control**: 控制工作流执行
  - 操作：pause、resume、cancel、retry
- **GET /api/v1/workflows/{id}/checkpoints**: 获取检查点列表
  - 响应：检查点ID、创建时间、状态快照

### Error Handling and Resilience
基于架构文档的错误处理策略：[Source: architecture/error-handling-strategy.md]
- **节点失败处理**: 自动重试机制，指数退避策略
- **状态恢复**: 从最近检查点恢复，保证数据一致性
- **死锁检测**: 循环依赖检测，超时自动解除
- **资源清理**: 失败或取消时的资源释放机制

## Testing

### Testing Standards [Source: architecture/testing-strategy.md]
- **测试文件位置**: 后端tests/ai/langgraph/，前端apps/web/tests/workflow/
- **后端测试框架**: pytest 7.4+ - 异步测试支持，状态管理测试
- **前端测试框架**: Vitest 1.0+ - 工作流可视化组件测试
- **集成测试**: 完整工作流执行场景测试
- **覆盖率要求**: LangGraph集成测试覆盖率 ≥85%

### Specific Testing Requirements for This Story
- StateGraph初始化和配置测试
- 状态持久化和恢复功能测试
- 工作流暂停、恢复、取消操作测试
- 条件路由和分支逻辑测试
- 检查点管理和版本控制测试
- 错误处理和恢复机制测试
- 工作流可视化组件渲染测试

### Test Data and Mocking Strategy
- Mock LangGraph状态转换用于单元测试
- 使用内存PostgreSQL进行检查点测试
- 创建测试工作流模板和状态数据
- 模拟长时间运行和失败场景
- Mock外部AI调用避免测试依赖

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### File List
- apps/api/src/ai/langgraph/state.py - MessagesState定义和状态工具函数
- apps/api/src/ai/langgraph/state_graph.py - LangGraph工作流构建器和执行引擎
- apps/api/src/ai/langgraph/checkpoints.py - PostgreSQL检查点存储实现
- apps/api/src/ai/langgraph/error_handling.py - 错误处理和重试策略
- apps/api/src/ai/langgraph/timeout_control.py - 超时管理和取消机制
- apps/api/src/ai/langgraph/event_system.py - 事件总线和状态监听器
- apps/api/src/ai/langgraph/__init__.py - 包导出定义
- apps/api/src/services/workflow_service.py - 工作流业务逻辑服务
- apps/api/src/api/v1/workflows.py - 工作流管理REST API
- apps/api/src/models/database/workflow.py - 工作流数据库模型
- apps/api/src/models/schemas/workflow.py - 工作流Pydantic模式
- apps/api/src/repositories/workflow_repository.py - 工作流数据访问层
- apps/api/src/tests/ai/langgraph/test_state_graph.py - StateGraph单元测试
- apps/web/src/components/workflow/WorkflowVisualization.tsx - 工作流可视化组件
- apps/web/src/components/workflow/NodeStatus.tsx - 节点状态显示组件
- apps/web/src/components/workflow/WorkflowDebugPanel.tsx - 调试面板组件
- apps/web/src/components/workflow/index.ts - 组件导出
- apps/web/src/types/workflow.ts - TypeScript类型定义
- apps/web/tests/workflow/WorkflowVisualization.test.tsx - 前端组件测试

### Completion Notes
- 成功实现了所有后端LangGraph集成功能，包括状态管理、检查点持久化、错误处理和事件系统
- 解决了多个导入和依赖问题，包括SQLAlchemy保留字冲突和相对导入错误
- 暂时禁用了langgraph.checkpoint.postgres依赖，使用自定义PostgreSQL实现
- 完成了前端工作流可视化组件，支持实时状态更新和交互式调试
- 所有测试通过，验证了核心功能的正确性

### Debug Log References
- SQLAlchemy metadata保留字错误 - 重命名为checkpoint_metadata解决
- LangGraph checkpoint导入错误 - 暂时禁用PostgreSQL checkpoint saver
- 相对导入错误 - 简化repository实现
- validate_state类型检查错误 - 增加类型验证逻辑
- SQLAlchemy异步会话查询错误 - 使用select()代替query()修复

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-05 | 1.0 | 初始故事创建 | Bob (Scrum Master) |
| 2025-08-05 | 1.1 | 完成LangGraph状态管理工作流实现 | James (Developer) |
| 2025-08-06 | 1.2 | 修复SQLAlchemy异步查询问题 | James (Developer) |