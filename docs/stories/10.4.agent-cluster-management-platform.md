# Story 10.4: æ™ºèƒ½ä½“é›†ç¾¤ç®¡ç†å¹³å°

**Story ID**: STORY-10.4-AGENT-CLUSTER-MGMT  
**Epic**: Epic 10 - åˆ†å¸ƒå¼æ™ºèƒ½ä½“ç½‘ç»œ  
**ä¼˜å…ˆçº§**: P1  
**é¢„ä¼°å·¥æœŸ**: 2-3å‘¨  
**æ•…äº‹ç‚¹æ•°**: 18  
**è´Ÿè´£å›¢é˜Ÿ**: è¿ç»´å›¢é˜Ÿ + åˆ†å¸ƒå¼ç³»ç»Ÿå›¢é˜Ÿ

## ğŸ“‹ ç”¨æˆ·æ•…äº‹

ä½œä¸ºç³»ç»Ÿè¿ç»´äººå‘˜å’ŒAIå¹³å°ç®¡ç†å‘˜ï¼Œæˆ‘éœ€è¦ä¸€ä¸ªæ™ºèƒ½ä½“é›†ç¾¤ç®¡ç†å¹³å°ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åŒ–ç®¡ç†å¤§è§„æ¨¡æ™ºèƒ½ä½“é›†ç¾¤çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬éƒ¨ç½²ã€æ‰©ç¼©å®¹ã€å¥åº·ç›‘æ§å’Œæ•…éšœæ¢å¤ï¼Œç¡®ä¿æ™ºèƒ½ä½“æœåŠ¡çš„é«˜å¯ç”¨æ€§å’Œèµ„æºä½¿ç”¨æ•ˆç‡ã€‚

### ğŸ¯ ç”¨æˆ·ä»·å€¼

- **è‡ªåŠ¨åŒ–ç®¡ç†**: æ™ºèƒ½ä½“å…¨ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨åŒ–ï¼Œå‡å°‘90%äººå·¥è¿ç»´
- **å¼¹æ€§æ‰©ç¼©**: åŸºäºè´Ÿè½½çš„è‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡
- **æ•…éšœè‡ªæ„ˆ**: æ™ºèƒ½æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨æ¢å¤ï¼Œç³»ç»Ÿå¯ç”¨æ€§>99.9%
- **ç»Ÿä¸€ç›‘æ§**: é›†ç¾¤çŠ¶æ€å¯è§†åŒ–ï¼Œæä¾›è¿ç»´å†³ç­–æ”¯æŒ

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½è¦æ±‚
- [ ] **æ™ºèƒ½ä½“ç”Ÿå‘½å‘¨æœŸ**: éƒ¨ç½²ã€å¯åŠ¨ã€åœæ­¢ã€å‡çº§ã€å›æ»šçš„å®Œæ•´ç®¡ç†
- [ ] **é›†ç¾¤ç¼–æ’**: åŸºäºKubernetesçš„æ™ºèƒ½ä½“é›†ç¾¤ç¼–æ’å’Œè°ƒåº¦
- [ ] **è‡ªåŠ¨æ‰©ç¼©å®¹**: åŸºäºCPUã€å†…å­˜ã€é˜Ÿåˆ—é•¿åº¦çš„è‡ªåŠ¨æ‰©ç¼©å®¹
- [ ] **å¥åº·ç›‘æ§**: å®æ—¶å¥åº·æ£€æŸ¥å’ŒæœåŠ¡å¯ç”¨æ€§ç›‘æ§
- [ ] **æ•…éšœæ¢å¤**: è‡ªåŠ¨æ•…éšœæ£€æµ‹ã€éš”ç¦»å’ŒæœåŠ¡æ¢å¤
- [ ] **é…ç½®ç®¡ç†**: é›†ä¸­åŒ–é…ç½®ç®¡ç†å’ŒåŠ¨æ€é…ç½®æ›´æ–°

### æŠ€æœ¯è¦æ±‚
- [ ] **æ‰©å±•æ€§**: æ”¯æŒ1000+æ™ºèƒ½ä½“å®ä¾‹çš„é›†ç¾¤ç®¡ç†
- [ ] **å“åº”é€Ÿåº¦**: æ‰©ç¼©å®¹æ“ä½œå“åº”æ—¶é—´<30ç§’
- [ ] **ç›‘æ§ç²¾åº¦**: å¥åº·æ£€æŸ¥é—´éš”<10ç§’ï¼Œæ•…éšœæ£€æµ‹å»¶è¿Ÿ<30ç§’
- [ ] **å¯ç”¨æ€§**: å¹³å°è‡ªèº«å¯ç”¨æ€§>99.95%ï¼Œé›¶å•ç‚¹æ•…éšœ
- [ ] **èµ„æºæ•ˆç‡**: é›†ç¾¤èµ„æºåˆ©ç”¨ç‡>80%

### æ€§èƒ½æŒ‡æ ‡
- [ ] **éƒ¨ç½²é€Ÿåº¦**: æ™ºèƒ½ä½“å®ä¾‹éƒ¨ç½²æ—¶é—´<2åˆ†é’Ÿ
- [ ] **æ‰©å®¹å“åº”**: è´Ÿè½½å¢åŠ æ—¶æ‰©å®¹å“åº”<60ç§’
- [ ] **æ•…éšœæ¢å¤**: æ•…éšœå®ä¾‹æ¢å¤æˆ–æ›¿æ¢<5åˆ†é’Ÿ
- [ ] **é…ç½®æ›´æ–°**: é…ç½®å˜æ›´æ¨é€å»¶è¿Ÿ<10ç§’

## ğŸ—ï¸ å®ç°æ–¹æ¡ˆ

### ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    A[ç®¡ç†æ§åˆ¶å°] --> B[é›†ç¾¤æ§åˆ¶å™¨]
    B --> C[Kubernetes API]
    C --> D[æ™ºèƒ½ä½“Pod]
    
    E[ç›‘æ§ç³»ç»Ÿ] --> F[æŒ‡æ ‡æ”¶é›†å™¨]
    F --> G[æ—¶åºæ•°æ®åº“]
    G --> H[å‘Šè­¦å¼•æ“]
    H --> I[è‡ªåŠ¨æ¢å¤]
    
    J[é…ç½®ä¸­å¿ƒ] --> K[é…ç½®åˆ†å‘]
    K --> D
    
    L[è´Ÿè½½å‡è¡¡å™¨] --> M[æœåŠ¡å‘ç°]
    M --> D
```

### æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 1. é›†ç¾¤æ§åˆ¶å™¨
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: æ™ºèƒ½ä½“åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°æ“ä½œ
- **èµ„æºè°ƒåº¦**: åŸºäºèµ„æºéœ€æ±‚çš„æ™ºèƒ½è°ƒåº¦
- **ç‰ˆæœ¬ç®¡ç†**: æ»šåŠ¨æ›´æ–°å’Œç‰ˆæœ¬å›æ»š
- **é›†ç¾¤çŠ¶æ€**: é›†ç¾¤æ•´ä½“çŠ¶æ€ç®¡ç†å’ŒåŒæ­¥

#### 2. è‡ªåŠ¨æ‰©ç¼©å®¹å¼•æ“
- **æŒ‡æ ‡ç›‘æ§**: CPUã€å†…å­˜ã€è‡ªå®šä¹‰æŒ‡æ ‡ç›‘æ§
- **æ‰©ç¼©å®¹ç®—æ³•**: åŸºäºé˜ˆå€¼å’Œé¢„æµ‹çš„æ‰©ç¼©å®¹å†³ç­–
- **èµ„æºé¢„ç•™**: é¢„ç•™èµ„æºæ± å’Œå¿«é€Ÿå“åº”æœºåˆ¶
- **æˆæœ¬ä¼˜åŒ–**: åŸºäºæˆæœ¬çš„èµ„æºåˆ†é…ä¼˜åŒ–

#### 3. å¥åº·ç›‘æ§ç³»ç»Ÿ
- **å¥åº·æ£€æŸ¥**: HTTPã€TCPã€è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
- **æ€§èƒ½ç›‘æ§**: å»¶è¿Ÿã€ååé‡ã€é”™è¯¯ç‡ç›‘æ§
- **å‘Šè­¦ç®¡ç†**: å¤šçº§å‘Šè­¦å’Œé€šçŸ¥æœºåˆ¶
- **å¯è§†åŒ–**: å®æ—¶ä»ªè¡¨æ¿å’Œå†å²è¶‹åŠ¿

#### 4. æ•…éšœæ¢å¤æœºåˆ¶
- **æ•…éšœæ£€æµ‹**: å¤šç»´åº¦æ•…éšœæ£€æµ‹ç®—æ³•
- **è‡ªåŠ¨éš”ç¦»**: æ•…éšœå®ä¾‹è‡ªåŠ¨éš”ç¦»å’Œæµé‡åˆ‡æ¢
- **æœåŠ¡æ¢å¤**: è‡ªåŠ¨é‡å¯ã€é‡æ–°è°ƒåº¦ã€å›æ»šæ“ä½œ
- **æ ¹å› åˆ†æ**: æ•…éšœåŸå› åˆ†æå’Œé¢„é˜²å»ºè®®

### æ•°æ®æ¨¡å‹

#### é›†ç¾¤é…ç½®è¡¨ (cluster_config)
```sql
CREATE TABLE cluster_config (
    id UUID PRIMARY KEY,
    cluster_name VARCHAR(255) NOT NULL,
    namespace VARCHAR(255) NOT NULL,
    min_replicas INTEGER DEFAULT 1,
    max_replicas INTEGER DEFAULT 10,
    target_cpu_percent INTEGER DEFAULT 70,
    target_memory_percent INTEGER DEFAULT 80,
    health_check_config JSONB,
    created_at TIMESTAMP WITH TIME ZONE
);
```

#### æ™ºèƒ½ä½“å®ä¾‹è¡¨ (agent_instances)
```sql
CREATE TABLE agent_instances (
    id UUID PRIMARY KEY,
    cluster_id UUID REFERENCES cluster_config(id),
    instance_id VARCHAR(255) NOT NULL,
    status VARCHAR(50) NOT NULL,
    node_name VARCHAR(255),
    cpu_usage FLOAT,
    memory_usage FLOAT,
    last_heartbeat TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE
);
```

### APIæ¥å£è®¾è®¡

#### RESTful APIè§„èŒƒ
- `POST /api/v1/clusters` - åˆ›å»ºé›†ç¾¤
- `GET /api/v1/clusters` - åˆ—å‡ºé›†ç¾¤
- `GET /api/v1/clusters/{id}` - è·å–é›†ç¾¤è¯¦æƒ…
- `PUT /api/v1/clusters/{id}/scale` - æ‰©ç¼©å®¹é›†ç¾¤
- `POST /api/v1/clusters/{id}/deploy` - éƒ¨ç½²æ–°ç‰ˆæœ¬
- `POST /api/v1/clusters/{id}/rollback` - å›æ»šç‰ˆæœ¬
- `GET /api/v1/clusters/{id}/health` - è·å–å¥åº·çŠ¶æ€

#### é›†ç¾¤ç®¡ç†ç¤ºä¾‹
```python
@app.post("/api/v1/clusters")
async def create_cluster(cluster: ClusterConfig):
    cluster_id = await cluster_manager.create_cluster(cluster)
    return {"cluster_id": cluster_id, "status": "creating"}

@app.put("/api/v1/clusters/{cluster_id}/scale")
async def scale_cluster(cluster_id: str, scale_request: ScaleRequest):
    result = await cluster_manager.scale_cluster(
        cluster_id, 
        scale_request.replicas
    )
    return {"status": "scaling", "target_replicas": scale_request.replicas}
```

### Kubernetesé…ç½®

#### æ™ºèƒ½ä½“Deploymentç¤ºä¾‹
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-agent-cluster
  namespace: ai-agents
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ai-agent
  template:
    metadata:
      labels:
        app: ai-agent
    spec:
      containers:
      - name: agent
        image: ai-agent:latest
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi" 
            cpu: "500m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
```

#### HPAé…ç½®
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ai-agent-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ai-agent-cluster
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

## ğŸ“‹ Tasks / Subtasks

- [ ] **Task 1**: æ„å»ºé›†ç¾¤æ§åˆ¶å™¨ (AC: 1, 2)
  - [ ] å®ç°Kubernetes APIé›†æˆ
  - [ ] å¼€å‘æ™ºèƒ½ä½“ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - [ ] æ·»åŠ èµ„æºè°ƒåº¦ç®—æ³•
  - [ ] é›†æˆç‰ˆæœ¬ç®¡ç†åŠŸèƒ½

- [ ] **Task 2**: å®ç°è‡ªåŠ¨æ‰©ç¼©å®¹ (AC: 3)
  - [ ] å¼€å‘æŒ‡æ ‡ç›‘æ§ç³»ç»Ÿ
  - [ ] å®ç°æ‰©ç¼©å®¹å†³ç­–å¼•æ“
  - [ ] æ·»åŠ æˆæœ¬ä¼˜åŒ–ç®—æ³•
  - [ ] é›†æˆé¢„æµ‹æ€§æ‰©ç¼©å®¹

- [ ] **Task 3**: æ„å»ºå¥åº·ç›‘æ§ç³»ç»Ÿ (AC: 4)
  - [ ] å®ç°å¤šç»´åº¦å¥åº·æ£€æŸ¥
  - [ ] å¼€å‘æ€§èƒ½æŒ‡æ ‡æ”¶é›†
  - [ ] æ·»åŠ å®æ—¶å‘Šè­¦åŠŸèƒ½
  - [ ] é›†æˆç›‘æ§ä»ªè¡¨æ¿

- [ ] **Task 4**: å¼€å‘æ•…éšœæ¢å¤æœºåˆ¶ (AC: 5)
  - [ ] å®ç°æ•…éšœæ£€æµ‹ç®—æ³•
  - [ ] å¼€å‘è‡ªåŠ¨æ¢å¤ç­–ç•¥
  - [ ] æ·»åŠ æ ¹å› åˆ†æåŠŸèƒ½
  - [ ] é›†æˆé¢„é˜²æ€§ç»´æŠ¤

- [ ] **Task 5**: å®ç°é…ç½®ç®¡ç†ç³»ç»Ÿ (AC: 6)
  - [ ] æ„å»ºé…ç½®ä¸­å¿ƒ
  - [ ] å®ç°åŠ¨æ€é…ç½®æ›´æ–°
  - [ ] æ·»åŠ é…ç½®éªŒè¯æœºåˆ¶
  - [ ] é›†æˆé…ç½®å®¡è®¡åŠŸèƒ½

- [ ] **Task 6**: æ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯• (AC: æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡)
  - [ ] ä¼˜åŒ–é›†ç¾¤æ“ä½œæ€§èƒ½
  - [ ] è¿›è¡Œå¤§è§„æ¨¡é›†ç¾¤æµ‹è¯•
  - [ ] å®ç°ç›‘æ§æ€§èƒ½è°ƒä¼˜
  - [ ] æ·»åŠ å‹åŠ›æµ‹è¯•è¦†ç›–

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- é›†ç¾¤æ§åˆ¶å™¨åŠŸèƒ½æµ‹è¯•
- æ‰©ç¼©å®¹ç®—æ³•æ­£ç¡®æ€§æµ‹è¯•
- å¥åº·æ£€æŸ¥æœºåˆ¶æµ‹è¯•
- APIæ¥å£åŠŸèƒ½æµ‹è¯•

### é›†æˆæµ‹è¯•
- Kubernetesé›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯é›†ç¾¤ç®¡ç†æµç¨‹æµ‹è¯•
- ç›‘æ§ç³»ç»Ÿé›†æˆæµ‹è¯•
- æ•…éšœæ¢å¤æµç¨‹éªŒè¯

### æ€§èƒ½æµ‹è¯•
- å¤§è§„æ¨¡é›†ç¾¤ç®¡ç†æ€§èƒ½æµ‹è¯•
- é«˜é¢‘æ‰©ç¼©å®¹å‹åŠ›æµ‹è¯•
- ç›‘æ§ç³»ç»Ÿæ€§èƒ½æµ‹è¯•
- ç½‘ç»œå’Œå­˜å‚¨æ€§èƒ½æµ‹è¯•

### æ··æ²Œå·¥ç¨‹
- èŠ‚ç‚¹æ•…éšœæ¨¡æ‹Ÿæµ‹è¯•
- ç½‘ç»œåˆ†åŒºæµ‹è¯•
- èµ„æºè€—å°½åœºæ™¯æµ‹è¯•
- é«˜è´Ÿè½½ç¨³å®šæ€§æµ‹è¯•

## ğŸ“¦ éƒ¨ç½²é…ç½®

### Dockeré…ç½®
```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY src/ .
EXPOSE 8080
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]
```

### Kuberneteséƒ¨ç½²
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cluster-manager
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: cluster-manager
        image: cluster-manager:latest
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi" 
            cpu: "1000m"
```

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### å…³é”®æŒ‡æ ‡
- é›†ç¾¤èŠ‚ç‚¹æ•°é‡å’Œå¥åº·çŠ¶æ€
- æ™ºèƒ½ä½“å®ä¾‹è¿è¡ŒçŠ¶æ€å’Œèµ„æºä½¿ç”¨
- æ‰©ç¼©å®¹æ“ä½œé¢‘ç‡å’ŒæˆåŠŸç‡
- æ•…éšœæ£€æµ‹å’Œæ¢å¤æ—¶é—´
- APIæ“ä½œå“åº”æ—¶é—´å’ŒæˆåŠŸç‡

### å‘Šè­¦è§„åˆ™
- é›†ç¾¤å¯ç”¨æ€§ä½äº99%
- æ™ºèƒ½ä½“å®ä¾‹æ•…éšœç‡è¶…è¿‡5%
- æ‰©ç¼©å®¹æ“ä½œå¤±è´¥è¶…è¿‡3æ¬¡
- èµ„æºä½¿ç”¨ç‡è¶…è¿‡90%
- æ•…éšœæ¢å¤æ—¶é—´è¶…è¿‡10åˆ†é’Ÿ

---

**Status**: Draft  
**Created**: 2025-08-30  
**Last Updated**: 2025-08-30  
**Dependencies**: Story 10.1, 10.2, 10.3  
**Technical Lead**: è¿ç»´å›¢é˜Ÿ  
**Stakeholders**: AIå¹³å°å›¢é˜Ÿ, åˆ†å¸ƒå¼ç³»ç»Ÿå›¢é˜Ÿ, è¿ç»´å›¢é˜Ÿ