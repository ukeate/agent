# Story 7.1: LangGraph v0.6 Context API Implementation

## Status
Draft

## Story
**As a** AI系统开发者,
**I want** 升级LangGraph到v0.6版本并实现新的Context API，替换现有的config['configurable']模式,
**so that** 获得类型安全的上下文传递、更好的开发体验、以及30%的性能提升基础

## Acceptance Criteria

1. **LangGraph版本升级**
   - 成功升级LangGraph从当前版本到v0.6.5+
   - 所有现有工作流继续正常运行
   - 无破坏性更改影响现有功能

2. **Context API实现**
   - 完全替换所有config['configurable']用法为新Context API
   - 实现类型安全的上下文定义和传递
   - 支持Context序列化和反序列化

3. **Durability控制集成**
   - 实现细粒度的checkpoint控制
   - 支持工作流状态持久化配置
   - 确保状态恢复机制正常工作

4. **Node级缓存实现**
   - 为计算密集型节点实现缓存机制
   - 支持Redis缓存后端集成
   - 缓存键策略和失效机制

5. **性能验证**
   - 基准测试显示至少15%性能提升
   - 内存使用优化
   - 响应时间改善

## Tasks / Subtasks

- [ ] **Task 1: 依赖升级和兼容性检查** (AC: 1)
  - [ ] 更新pyproject.toml中LangGraph版本到0.6.5+
  - [ ] 运行dependency检查，解决版本冲突
  - [ ] 创建升级前的功能baseline测试
  - [ ] 备份当前工作流程实现

- [ ] **Task 2: Context API基础实现** (AC: 2)
  - [ ] 创建新的Context类型定义在`apps/api/src/ai/langgraph/context.py`
  - [ ] 实现Context序列化/反序列化方法
  - [ ] 创建Context工厂函数和验证器
  - [ ] 添加类型安全的Context传递机制

- [ ] **Task 3: 迁移现有工作流到Context API** (AC: 2)
  - [ ] 识别所有使用config['configurable']的位置
  - [ ] 逐个迁移到新的Context API
  - [ ] 更新state_graph.py使用新API
  - [ ] 确保向后兼容性（如果需要）

- [ ] **Task 4: Durability控制实现** (AC: 3)
  - [ ] 在`apps/api/src/ai/langgraph/checkpoints.py`实现新的checkpoint策略
  - [ ] 配置PostgreSQL checkpoint存储
  - [ ] 实现状态恢复和回滚机制
  - [ ] 添加checkpoint清理策略

- [ ] **Task 5: Node缓存系统实现** (AC: 4)
  - [ ] 创建`apps/api/src/ai/langgraph/caching.py`缓存模块
  - [ ] 实现Redis缓存适配器
  - [ ] 为关键节点添加@cached装饰器
  - [ ] 实现缓存预热和失效策略

- [ ] **Task 6: 性能测试和优化** (AC: 5)
  - [ ] 创建性能基准测试套件
  - [ ] 运行前后对比测试
  - [ ] 优化瓶颈节点
  - [ ] 生成性能报告

- [ ] **Task 7: 集成测试和文档更新** (AC: 1, 2, 3, 4)
  - [ ] 完整的集成测试覆盖
  - [ ] 更新开发文档
  - [ ] 创建迁移指南
  - [ ] 代码审查和重构

## Dev Notes

### Previous Story Insights
这是upgrade-2025计划的第一个故事，开启核心性能提升Epic。需要特别注意保持现有功能的稳定性，同时为后续的AutoGen v0.4升级和Qdrant BM42集成打好基础。

### LangGraph架构更新要点
**Context API核心概念** [Source: architecture/core-workflows.md#context-api工作流]:
- 类型安全的上下文传递，替代传统config模式
- Durability控制实现细粒度状态管理
- Node缓存优化开发迭代和运行时性能

### Data Models
**Context数据结构** [Source: 基于LangGraph 0.6文档推断]:
```python
from typing import TypedDict, Optional, Any
from langgraph.checkpoint import Checkpoint
from langgraph.context import Context

class WorkflowContext(TypedDict):
    """类型安全的工作流上下文"""
    user_id: str
    session_id: str
    conversation_id: Optional[str]
    metadata: dict[str, Any]
    checkpoint_config: dict[str, Any]

class NodeContext(TypedDict):
    """节点级别上下文"""
    node_id: str
    input_data: Any
    cache_key: Optional[str]
    execution_metadata: dict[str, Any]
```

### API Specifications
**LangGraph服务端点升级** [Source: architecture/api-specification.md - 推断需要更新]:
```python
# 工作流管理API需要支持新的Context
POST /api/v1/workflows/execute - 执行工作流（支持Context）
GET /api/v1/workflows/{id}/context - 获取工作流上下文
PUT /api/v1/workflows/{id}/checkpoint - 更新检查点

# 缓存管理API
GET /api/v1/cache/nodes/{node_id} - 获取节点缓存
DELETE /api/v1/cache/nodes/{node_id} - 清除节点缓存
```

### File Locations
基于项目结构 [Source: architecture/unified-project-structure.md]:
- **LangGraph核心模块**: `apps/api/src/ai/langgraph/`
  - `context.py` - Context API实现（新建）
  - `state_graph.py` - 状态图实现（需更新）
  - `checkpoints.py` - 检查点管理（需更新）
  - `caching.py` - 节点缓存实现（新建）
  - `state.py` - 状态管理（需更新）
  - `__init__.py` - 模块导出
- **测试文件**: `apps/api/tests/ai/langgraph/`
  - `test_context_api.py` - Context API测试（新建）
  - `test_caching.py` - 缓存测试（新建）
  - `test_state_graph.py` - 更新现有测试
- **配置文件**: 
  - `apps/api/pyproject.toml` - 更新LangGraph版本
  - `apps/api/src/core/config.py` - 可能需要新配置项

### Technical Constraints
**版本和兼容性要求** [Source: architecture/tech-stack.md]:
- **LangGraph版本**: 必须升级到0.6.5或更高
- **Python版本**: 3.11+ (已满足)
- **Redis版本**: 7.2+ (用于缓存)
- **PostgreSQL**: 15+ (用于checkpoint存储)
- **向后兼容**: 需要提供迁移路径，避免破坏现有功能

### Migration Strategy
**从config到Context的迁移步骤**:
1. 识别所有`config['configurable']`使用位置
2. 创建Context类型定义映射现有配置
3. 实现Context转换器兼容旧代码
4. 逐步替换，保持双轨运行
5. 完全迁移后移除旧代码

### Performance Considerations
**性能优化重点**:
- Node缓存针对RAG检索和LLM调用节点
- Checkpoint优化减少数据库I/O
- Context序列化使用高效格式（如MessagePack）
- 批量操作和异步处理优化

### Testing Requirements
基于测试策略 [Source: architecture/testing-strategy.md]:
- **单元测试**: `apps/api/tests/ai/langgraph/`
  - Context API的类型安全测试
  - 缓存机制的正确性测试
  - Checkpoint的持久化测试
- **集成测试**: `apps/api/tests/integration/`
  - 完整工作流的Context传递测试
  - 性能基准对比测试
  - 故障恢复测试
- **测试覆盖率**: AI模块需要≥85%覆盖率
- **性能测试**: 使用pytest-benchmark进行性能对比

### Testing
**位置**: apps/api/tests/ai/langgraph/
**框架**: pytest + pytest-asyncio + pytest-benchmark
**覆盖率**: LangGraph模块需要≥85%测试覆盖率
**重点测试**:
- Context类型安全性验证
- 迁移后功能完整性验证
- 缓存命中率和性能提升验证
- Checkpoint恢复正确性验证
- 并发和异步场景测试

## Dev Agent Record

### Agent Model Used
[待开发时填写]

### Debug Log References
[待开发时填写]

### Completion Notes List
[待开发时填写]

### File List
[待开发时填写]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-19 | 1.0 | Initial story creation for LangGraph v0.6 Context API upgrade | Bob (Scrum Master) |

## QA Results
[待QA审查后填写]