# NATS服务器配置 - 节点2
server_name: nats-2

# 客户端连接配置
listen: 0.0.0.0:4222
max_connections: 65536
max_control_line: 4KB
max_payload: 1MB
max_pending: 67108864

# HTTP监控端口
http: 0.0.0.0:8222

# 系统账户配置
accounts {
    $SYS {
        users = [
            {
                user: "admin"
                pass: "$2a$11$DRh4C0KNbNnD8K/hb/buWe1zPxEHrLEiDmuq1Mi0rRJiH/W25Qidm"
            }
        ]
    }
    
    # 智能体系统账户
    AGENTS {
        users = [
            {
                user: "agent_system"
                pass: "$2a$11$V1qrQKzOaTCwUlgxEd7e6.Ql14xyXL7a0J6YcOXl9TRZi3sQXoVmu"
                permissions = {
                    publish = {
                        allow = "agents.>"
                    }
                    subscribe = {
                        allow = "agents.>"
                    }
                }
            }
        ]
        jetstream: enabled
        jetstream: {
            max_memory: 1GB
            max_file: 10GB
            max_streams: 1000
            max_consumers: 1000
        }
    }
}

# JetStream配置
jetstream {
    store_dir: "/data/jetstream"
    max_memory_store: 2GB
    max_file_store: 20GB
    max_streams: 10000
    max_consumers: 10000
    
    # 集群复制配置
    unique_tag: "az"
}

# 集群配置
cluster {
    name: "agent-cluster"
    listen: 0.0.0.0:6222
    
    # 路由到其他节点
    routes: [
        "nats://nats-1:6222"
        "nats://nats-3:6222"
    ]
    
    # 集群权限
    authorization {
        user: cluster
        password: cluster_pass
        timeout: 2s
    }
    
    # 集群连接池
    pool_size: 5
    accounts: [AGENTS]
}

# 服务器标签（用于JetStream放置）
server_tags: [
    "cluster:agent-cluster"
    "region:local"
    "az:az-2"
    "node_type:replica"
]

# 日志配置
log_file: "/var/log/nats/nats-server.log"
log_size_limit: 100MB
max_traced_msg_len: 32768
logtime: true
debug: false
trace: false
syslog: false

# 连接限制和超时
write_deadline: "10s"
ping_interval: "2m"
ping_max: 2
max_outstanding_pings: 2

# TLS配置 (生产环境使用)
# tls {
#     cert_file: "/etc/ssl/nats-server.crt"
#     key_file: "/etc/ssl/nats-server.key"
#     ca_file: "/etc/ssl/nats-ca.crt"
#     verify: true
#     timeout: 5
#     cipher_suites: [
#         "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"
#         "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
#         "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
#         "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
#     ]
#     curve_preferences: [
#         "CurveP256"
#         "CurveP384"
#         "CurveP521"
#     ]
# }

# 性能优化配置
no_sys_acc: false
system_account: "$SYS"

# 垃圾回收优化
soft_memory_limit: "75%"
block_size: "8mb"

# 连接认证
# authorization {
#     user: nats
#     password: password
#     timeout: 1.0
# }

# 运行时限制
limits {
    max_conn: 65536
    max_subs: 0
    max_payload: 1MB
    max_control_line: 4KB
    max_pending: 67108864
}

# 监控和统计
http_stats: true